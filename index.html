<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Mean Radiant Temperature for Philadelphia County</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font: bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .map-overlay {
            font: bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            color: #ffff;
            position: absolute;
            width: 20%;
            top: 0;
            right: 0;
            padding: 10px;
        }

        .map-overlay-inner {
            background-color: #696969;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay label {
            display: block;
            margin: 0 0 10px;
        }

        .legend .bar {
            height: 10px;
            width: 100%;
            background: linear-gradient(to right,
                    #000004 20%, #57106E 20% 40%, #BC3755 40% 60%, #FA8D0A 60% 80%, #FDFFA5 80%);
        }

        .map-overlay input {
            background-color: transparent;
            display: inline-block;
            width: 100%;
            position: relative;
            margin: 0;
            cursor: ew-resize;
        }

        .window {
            font: bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            padding: 30px;
            color: #ffff;
            background-color: #696969;
            border-radius: 20px;
            box-shadow: 0px 3px 10px rgba(0, 0, 0, .8);
            z-index: 1000;
        }

        .window.landing {
            position: absolute;
            top: 60px;
            bottom: 40px;
            left: 10px;
            right: 10px;
        }

        .window h1 {
            margin-top: 0;
        }

        .landing {
            margin: auto;
            max-width: 400px;
            max-height: 275px;
        }

    </style>
</head>

<body>
    <div class="window landing" style="display:block" onclick="this.remove()">
        <h1>Urban Heat Vulnerability</h1>
        <h2>and Thermal Comfort</h2>
        <p><strong>This map displays the mean radiant temperature in Philadelphia County in an attempt to visualize areas of high or low human thermal comfort. Recent summers have been some of the hottest on record and certain demographic groups are more vulnerable to extreme heat than others. This map can be used to find areas with high average mean radiant temperature and vulnerable populations that may need additional support and resources during the hottest months of the year. For more information please visit the wiki for <a href="https://en.wikipedia.org/wiki/Thermal_comfort"  target="_blank">thermal comfort</a>.</strong></p>
        <hr>
        <p>Click here to explore the map</p>
    </div>
    <div id="map"></div>

    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <label>Raster Opacity: <span id="slider-value">100%</span></label>
            <input id="slider" type="range" min="0" max="100" step="0" value="100" />
        </div>
        <div class='map-overlay-inner'>
            <h2>Census Demographics</h2>
            <div id='pd'>
                <h3>Hover over a tract</h3>
                <p></p>
                <strong>Average Mean Radiant Temperature: 0</strong><br>
                <strong>Total Population: 0</strong><br>
                <strong style="margin-left: 20px">Population White: 0</strong><br>
                <strong style="margin-left: 20px">Population White Non-Hispanic: 0</strong><br>
                <strong style="margin-left: 20px">Population Black: 0</strong><br>
                <strong style="margin-left: 20px">Population Asian: 0</strong><br>
                <strong style="margin-left: 20px">Population Hispanic: 0</strong><br>
                <strong>Males over 65: 0</strong><br>
                <strong>Males under 18: 0</strong><br>
                <strong>Females over 65: 0</strong><br>
                <strong>Females under 18: 0</strong><br>
                <strong>Median Household Income: 0</strong><br>
                <strong>Per Capita Income: 0</strong><br>
                <strong>Bachelors Degree: 0</strong><br>
                <strong>High School: 0</strong><br>
                <strong>Less than High School: 0</strong>
            </div>
        </div>
        <div class="map-overlay-inner">
            <h3>Mean Radiant Temperature (Â°C)</h3>
            <p><strong>Mean Radiant Temperature is described as the area-weighted mean temperature of all the objects surrounding the body. The mean radiant temperature calculation takes into account variables such as temperature, humidity, solar radiation (both direct and indirect) as well as ground cover, buildings, and vegetation. For more information please vist the wiki for <a href="https://en.wikipedia.org/wiki/Mean_radiant_temperature"  target="_blank">Mean Radiant Temperature</a>.</strong></p>
            <div id="legend" class="legend">
                <div class="bar"></div>
                <div style="display: flex; justify-content: space-around">
                    <div>32 - 36</div>
                    <div>37 - 41</div>
                    <div>42 - 47</div>
                    <div>48 - 51</div>
                    <div>51 - 56</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoib2NsYXJrIiwiYSI6ImNrYnoxZGN4bTA0em8zMHVydWJtd3BhejUifQ.exel6XEQDKINDkELlD_qmg';

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/oclark/ckcf3ppg61it51ip9zwtgq8j2',
            maxZoom: 22,
            minZoom: 3,
            zoom: 11,
            center: [-75.0963, 40.0035],
            hash: true // adds lat and lon to url
        });

        var slider = document.getElementById('slider');
        var sliderValue = document.getElementById('slider-value');

        map.on('load', function() {

            map.addSource('mrt_philly', {
                type: 'raster',
                url: 'mapbox://oclark.8jbx5ifv'
            });

            map.addLayer({
                'id': 'philly_ras',
                'type': 'raster',
                'source': 'mrt_philly'
            });

            //Greyscale version
            /*            map.addSource('mrt_philly_grey', {
                        type: 'raster',
                        url: 'mapbox://oclark.6eclovjc'
                        });

                        map.addLayer({
                        'id': 'philly_ras_grey',
                        'type': 'raster',
                        'source': 'mrt_philly_grey'
                        });*/

            //this retrieves the tileset as a PNG instead of a JPEG allowing for transparency of the background 'NoData' values
            /*            map.addLayer({
                            'id': 'philly_ras',
                            'type': 'raster',
                            source: {
                                type: 'raster',
                                tiles: ['https://api.mapbox.com/v4/oclark.3vih5au2/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib2NsYXJrIiwiYSI6ImNrYnoxZGN4bTA0em8zMHVydWJtd3BhejUifQ.exel6XEQDKINDkELlD_qmg'],
                            }
                        });*/

            map.addSource('mrt_census_tracts', {
                type: 'vector',
                url: 'mapbox://oclark.32esvlru'
            });
            map.addLayer({
                'id': 'census_tracts',
                'type': 'fill',
                'source': 'mrt_census_tracts',
                'source-layer': 'mrt_census_tract-dfatpp',
                'layout': {},
                'paint': {
                    'fill-opacity': 0
                }
            });

            map.addLayer({
                'id': 'census_tracts_border',
                'type': 'line',
                'source': 'mrt_census_tracts',
                'source-layer': 'mrt_census_tract-dfatpp',
                'layout': {},
                'paint': {
                    'line-width': 2,
                    'line-color': '#000000'
                }
            });

            // Sends raster opasity to slider element
            slider.addEventListener('input', function(e) {
                map.setPaintProperty(
                    'philly_ras',
                    'raster-opacity',
                    parseInt(e.target.value, 10) / 100
                );

                // Value indicator
                sliderValue.textContent = e.target.value + '%';
            });

            //Sends census tract properties to map overlay
            map.on('mousemove', function(e) {
                var census_tract = map.queryRenderedFeatures(e.point, {
                    layers: ['census_tracts']
                });

                if (census_tract.length > 0) {
                    document.getElementById('pd').innerHTML = '<h3><strong>' + census_tract[0].properties.NAMELSAD +
                        '</strong></h3><p><strong>' +
                        '<strong>Average Mean Radiant Temperature: ' + census_tract[0].properties.mrt.toFixed(2) +
                        '</strong><br><strong>' + 'Total Population: ' + census_tract[0].properties.total_popu +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population White: ' + census_tract[0].properties.white_popu +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population White Non-Hispanic: ' + census_tract[0].properties["non-hispan"] +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population Black: ' + census_tract[0].properties.black_popu +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population Asian: ' + census_tract[0].properties.asian_popu +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population Hispanic: ' + census_tract[0].properties.hispanic_p +
                        '</strong><br><strong>' + 'Males over 65: ' + (Number(census_tract[0].properties.male65_66) + Number(census_tract[0].properties.male67_69) + Number(census_tract[0].properties.male70_74) + Number(census_tract[0].properties.male75_79) + Number(census_tract[0].properties.male80_84) + Number(census_tract[0].properties.male85_)) +
                        '</strong><br><strong>' + 'Males under 18: ' + census_tract[0].properties.male_und18 +
                        '</strong><br><strong>' + 'Females over 65: ' + (Number(census_tract[0].properties.fema_65_66) + Number(census_tract[0].properties.fema_67_69) + Number(census_tract[0].properties.fema70_74) + Number(census_tract[0].properties.fema75_79) + Number(census_tract[0].properties.fema80_84) + Number(census_tract[0].properties.fema85_)) +
                        '</strong><br><strong>' + 'Females under 18: ' + census_tract[0].properties.female_und +
                        '</strong><br><strong>' + 'Median Household Income: ' + census_tract[0].properties.median_hou +
                        '</strong><br><strong>' + 'Per Capita Income: ' + census_tract[0].properties.per_capita +
                        '</strong><br><strong>' + 'Bachelors Degree: ' + census_tract[0].properties.bachelor +
                        '</strong><br><strong>' + 'High School: ' + census_tract[0].properties.totaleduca +
                        '</strong><br><strong>' + 'Less than High School: ' + census_tract[0].properties.less_highs +
                        '</strong>';
                } else {
                    document.getElementById('pd').innerHTML = '<h3><strong>' + "Hover over a tract" +
                        '</strong></h3><p><strong>' +
                        '<strong>Average Mean Radiant Temperature: ' + 0 +
                        '</strong><br><strong>' + 'Total Population: ' + 0 +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population White: ' + 0 +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population White Non-Hispanic: ' + 0 +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population Black: ' + 0 +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population Asian: ' + 0 +
                        '</strong><br><strong style="margin-left: 20px">' + 'Population Hispanic: ' + 0 +
                        '</strong><br><strong>' + 'Males over 65: ' + 0 +
                        '</strong><br><strong>' + 'Males under 18: ' + 0 +
                        '</strong><br><strong>' + 'Females over 65: ' + 0 +
                        '</strong><br><strong>' + 'Females under 18: ' + 0 +
                        '</strong><br><strong>' + 'Median Household Income: ' + 0 +
                        '</strong><br><strong>' + 'Per Capita Income: ' + 0 +
                        '</strong><br><strong>' + 'Bachelors Degree: ' + 0 +
                        '</strong><br><strong>' + 'High School: ' + 0 +
                        '</strong><br><strong>' + 'Less than High School: ' + 0 +
                        '</strong>';
                }
            });

            // Change the cursor to a pointer when the mouse is over the census tracts layer.
            map.on('mouseenter', 'census_tracts', function() {
                map.getCanvas().style.cursor = 'pointer';
            });

            // Change it back to a pointer when it leaves.
            map.on('mouseleave', 'census_tracts', function() {
                map.getCanvas().style.cursor = '';
            });

            var click = document.getElementById('click');

            // Sends request to Mapbox with geocoder (lat lon of click) and returns address
            // Places address in popup
            map.on('click', function(e) {
                //console.log(e.lngLat.lng + ',' + e.lngLat.lat);
                var latlong = e.lngLat.lng + ',' + e.lngLat.lat;
                var url = 'https://api.tiles.mapbox.com/v4/geocode/mapbox.places-v1/' + latlong + '.json?access_token=' + 'pk.eyJ1Ijoib2NsYXJrIiwiYSI6ImNrYnoxZGN4bTA0em8zMHVydWJtd3BhejUifQ.exel6XEQDKINDkELlD_qmg';

                xmlHttp = null;
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open("GET", url, false);
                xmlHttp.send();

                var responseJSON = JSON.parse(xmlHttp.responseText);
                var placename = responseJSON['features'][0]['place_name'];
                //console.log(placename);
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(placename)
                    .addTo(map);
            });

        });

    </script>

</body>

</html>
